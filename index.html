<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo do Impostor P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a; --card-color: #2d2d2d; --primary: #646cff;
            --secondary: #444; --text: #ffffff; --danger: #ff4646; --success: #4cd964;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; }
        .container { background-color: var(--card-color); padding: 2rem; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); width: 90%; max-width: 450px; box-sizing: border-box; margin: 20px; }
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #bbb; font-weight: 500; }
        
        input, select { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #555; background: #333; color: white; box-sizing: border-box; }
        button { background-color: var(--primary); color: white; border: none; padding: 1rem; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 1rem; font-weight: bold; }
        button.success { background-color: var(--success); color: #000; }
        button.secondary { background-color: var(--secondary); }
        
        .role-card { border: 2px dashed var(--primary); padding: 2rem; margin: 1rem 0; border-radius: 8px; background: rgba(100, 108, 255, 0.1); }
        .secret-word { font-size: 2rem; color: var(--success); font-weight: bold; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; width: 100%; }
        .player-grid button { margin-top: 0; }
        .share-box { background: #222; padding: 15px; border-radius: 8px; word-break: break-all; border: 1px solid #444; margin: 10px 0; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="container">
        <div id="setup-screen" class="screen active">
            <h1>üïµÔ∏è Quem √© o Impostor?</h1>
            
            <div id="waiting-msg" style="display:none;">
                <h2 style="color: var(--success);">Ligado ao L√≠der!</h2>
                <p>Aguarde o in√≠cio da partida...</p>
            </div>

            <div id="setup-inputs">
                <div class="input-group">
                    <label>Categoria</label>
                    <select id="categorySelect"><option value="aleatorio">üé≤ Aleat√≥rio</option></select>
                </div>
                <div class="input-group">
                    <label>Quantia de jogadores</label>
                    <input type="number" id="playerCount" value="3" min="3">
                </div>
                <div class="input-group">
                    <label>Quantia de impostores</label>
                    <input type="number" id="impostorCount" value="1" min="1">
                </div>
                <button class="success" onclick="prepareOnlineGame()">Gerar Sala Online</button>
            </div>

            <div id="online-share-area" style="display:none;">
                <h3>üîó Link da Sala:</h3>
                <div class="share-box" id="shareLinkText">A carregar...</div>
                <button class="success" onclick="copyLink()">Copiar Link</button>
                <p id="connected-count" style="color: #ffca28;">Aguardando pelo menos 2 amigos...</p>
                <div id="start-button-container"></div>
                <button class="secondary" onclick="resetGame()">Cancelar</button>
            </div>
        </div>

        <div id="pick-player-screen" class="screen">
            <h2>Escolha seu n√∫mero</h2>
            <div class="player-grid" id="playerGrid"></div>
            <button class="secondary" onclick="resetGame()">Sair</button>
        </div>

        <div id="reveal-screen" class="screen">
            <h1>Sua Fun√ß√£o</h1>
            <div class="role-card" id="roleContent"></div>
            <div id="host-controls" style="display:none">
                <button class="success" onclick="broadcastRestart()">Jogar Novamente</button>
            </div>
            <p id="client-msg" style="display:none; color: #aaa;">Aguarde o l√≠der reiniciar...</p>
            <button class="secondary" onclick="resetGame()">Sair</button>
        </div>
    </div>

    <script>
        const gameData = {
            "Cozinha": ["Geladeira", "Micro-ondas", "Fog√£o", "Liquidificador", "Pia", "Garfo", "Panela"],
            
            "Valorant": [
                "Jett",
                "Phoenix",
                "Reyna",
                "Raze",
                "Yoru",
                "Neon",
                "Iso",
                "Brimstone",
                "Omen",
                "Viper",
                "Astra",
                "Harbor",
                "Clove",
                "Sova",
                "Breach",
                "Skye",
                "KAY/O",
                "Fade",
                "Gekko",
                "Sage",
                "Cypher",
                "Killjoy",
                "Chamber",
                "Veto",
                "Waylay",
                "Tejo",
                "DeadLock",
                "Gekko"
            ],


            "Escola": ["Lousa", "Carteira", "Professor", "Caderno", "Mochila", "Caneta"],
            "Animais": ["Cachorro", "Gato", "Elefante", "Le√£o", "Pinguim", "Girafa", "Tubar√£o"],
            "Pa√≠ses": ["Brasil", "Jap√£o", "EUA", "It√°lia", "Egito", "Fran√ßa", "China"],
            "Tecnologia": ["PC", "Celular", "Mouse", "Teclado", "Servidor", "Wifi", "Fone"],
            "Clash Royale": [
            "Flechas", "Bombardeiro", "Arqueiras", "Cavaleiro", "Bola de Fogo",
            "Mini P.E.K.K.A", "Mosqueteira", "Gigante", "Pr√≠ncipe", "Drag√£o Beb√™",
            "Ex√©rcito de Esqueletos", "Bruxa", "Goblins Lanceiros", "Goblins", "Cabana de Goblins",
            "Valqu√≠ria", "Rel√¢mpago", "Barril de Goblins", "Esqueletos", "Servos",
            "L√°pide", "Torre de Bombas", "Esqueleto Gigante", "Bal√£o", "Canh√£o",
            "B√°rbaros", "Foguete", "Cabana de B√°rbaros", "F√∫ria", "X-Besta",
            "Tesla", "Horda de Servos", "Torre Inferno", "Corredor", "Feiti√ßo de Gelo",
            "P.E.K.K.A", "Zap", "Mago", "Espelho", "Morteiro",
            "Coletor de Elixir", "Golem", "Gigante Real", "Tr√™s Mosqueteiras", "Pr√≠ncipe das Trevas",
            "VenenO", "Mago de Gelo", "Princesa", "Esp√≠rito de Fogo", "Fornalha",
            "Guardas", "Lava Hound", "Mineiro", "Sparky", "Lan√ßador",
            "Esp√≠rito de Gelo", "Lenhador", "O Tronco", "Megasservo", "Drag√£o Infernal",
            "Golem de Gelo", "Cemit√©rio", "Tornado", "B√°rbaros de Elite", "Clone",
            "Mago El√©trico", "Goblin com Dardo", "Executor", "Ariete de Batalha", "Gangue de Goblins",
            "Bandida", "Bruxa Sombria", "Morcegos", "Carrinho de Canh√£o", "M√°quina Voadora",
            "Barril de Esqueletos", "Megacavaleiro", "Eletrocutadores", "Ca√ßador", "Fantasma Real",
            "Arqueiro M√°gico", "Barril de B√°rbaro", "Patifes", "Porcos Reais", "Bola de Neve",
            "Recrutas Reais", "Goblin Gigante", "Drag√£o El√©trico", "Domadora de Carneiro", "Destruidores de Muros",
            "Terremoto", "Jaula de Goblin", "Pescador", "Golem de Elixir", "Curadora Guerreira",
            "Pirot√©cnica", "Encomenda Real", "Esp√≠rito Curador", "Drag√µes Esqueleto", "Gigante El√©trico",
            "Esp√≠rito El√©trico", "Bruxa M√£e", "Escavadeira de Goblins", "Cavaleiro Dourado", "Rainha Arqueira",
            "Rei Esqueleto", "Mineiro Bombado", "Monge", "F√™nix", "Pequeno Pr√≠ncipe",
            "Feiti√ßo de V√°cuo", "Goblin Demolidor", "M√°quina Goblin", "Maldi√ß√£o Goblin", "Arbusto Tra√ßoeiro",
            "Goblinstein", "Gigante das Runas", "Berserker", "Imperatriz Espiritual", "Vinhas"
            ]
        };

        let peer, conn, connections = [];
        let isHost = false, currentPlayers = [], currentSecret = "", currentCategory = "";

        window.onload = () => {
            Object.keys(gameData).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.innerText = cat;
                document.getElementById('categorySelect').appendChild(opt);
            });
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('room')) joinRoom(urlParams.get('room'));
        };

        function prepareOnlineGame() {
            isHost = true;
            peer = new Peer();
            peer.on('open', id => {
                const url = window.location.origin + window.location.pathname + '?room=' + id;
                document.getElementById('shareLinkText').innerText = url;
                document.getElementById('setup-inputs').style.display = 'none';
                document.getElementById('online-share-area').style.display = 'block';
            });
            peer.on('connection', c => {
                connections.push(c);
                updateConnectedCount();
            });
        }

        function joinRoom(id) {
            isHost = false;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                conn.on('open', () => {
                    document.getElementById('setup-inputs').style.display = 'none';
                    document.getElementById('waiting-msg').style.display = 'block';
                });
                conn.on('data', data => handleData(data));
            });
        }

        function handleData(data) {
            if (data.type === 'RESTART') {
                // Sincroniza a l√≥gica de jogo com os dados REAIS vindos do l√≠der
                setupGameLogic(data.params.p, data.params.i, data.params.c, data.seed);
                // Gera a quantidade exata de bot√µes enviada pelo l√≠der
                showPlayerSelectionScreen(data.params.p);
            }
        }

        function updateConnectedCount() {
            const count = connections.length;
            const container = document.getElementById('start-button-container');
            const statusMsg = document.getElementById('connected-count');
            
            statusMsg.innerText = `${count} amigo(s) conectado(s).`;
            
            if (count >= 2) {
                statusMsg.style.color = "#4cd964";
                if (container.innerHTML === "") {
                    const btn = document.createElement('button');
                    btn.innerText = "COME√áAR JOGO";
                    btn.className = "success";
                    btn.onclick = broadcastRestart;
                    container.appendChild(btn);
                }
            } else {
                statusMsg.style.color = "#ffca28";
                container.innerHTML = "";
            }
        }

        function broadcastRestart() {
            if (!isHost) return;
            const pCount = parseInt(document.getElementById('playerCount').value);
            const iCount = parseInt(document.getElementById('impostorCount').value);
            
            if (pCount < 3) return alert("O jogo precisa de no m√≠nimo 3 jogadores!");
            
            let cat = document.getElementById('categorySelect').value;
            if (cat === 'aleatorio') {
                const keys = Object.keys(gameData);
                cat = keys[Math.floor(Math.random() * keys.length)];
            }
            
            const seed = Math.floor(Math.random() * 99999);
            const payload = { type: 'RESTART', seed: seed, params: { p: pCount, i: iCount, c: cat } };
            
            // Envia para todos os amigos os par√¢metros exatos configurados aqui
            connections.forEach(c => c.send(payload));
            handleData(payload); // O Host tamb√©m executa
        }

        function setupGameLogic(p, i, cat, seed) {
            currentCategory = cat;
            const words = gameData[cat];
            const seededRandom = (s) => { var x = Math.sin(s) * 10000; return x - Math.floor(x); };
            currentSecret = words[Math.floor(seededRandom(seed) * words.length)];
            currentPlayers = Array(p).fill('innocent');
            for(let k=0; k<i; k++) if(k < p) currentPlayers[k] = 'impostor';
            
            let s = seed;
            for (let m = currentPlayers.length - 1; m > 0; m--) {
                const j = Math.floor(seededRandom(s++) * (m + 1));
                [currentPlayers[m], currentPlayers[j]] = [currentPlayers[j], currentPlayers[m]];
            }
        }

        function showPlayerSelectionScreen(total) {
            const grid = document.getElementById('playerGrid');
            grid.innerHTML = '';
            // Usa o par√¢metro "total" que veio do l√≠der, ignorando o input local
            for(let i=0; i<total; i++) {
                const btn = document.createElement('button');
                btn.innerText = `Jogador ${i+1}`;
                btn.onclick = () => revealRole(i);
                grid.appendChild(btn);
            }
            switchScreen('pick-player-screen');
        }

        function revealRole(idx) {
            const role = currentPlayers[idx];
            const content = document.getElementById('roleContent');
            content.innerHTML = role === 'impostor' ? `<div style="color:var(--danger); font-size:2rem; font-weight:bold;">IMPOSTOR</div>` : `<div>A palavra √©:</div><div class="secret-word">${currentSecret}</div>`;
            content.innerHTML += `<div style="margin-top:10px; color:#aaa">Categoria: ${currentCategory}</div>`;
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            document.getElementById('client-msg').style.display = isHost ? 'none' : 'block';
            switchScreen('reveal-screen');
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('shareLinkText').innerText);
            alert("Link copiado!");
        }

        function resetGame() { window.location.href = window.location.pathname; }
    </script>
</body>
</html>